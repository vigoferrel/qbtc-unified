#!/usr/bin/env node

/**
 * QBTC UNIFIED LAUNCHER
 * Launcher completo que integra todos los sistemas de proxy y VPN
 * Sistema inteligente que selecciona y ejecuta la mejor opci√≥n disponible
 */

const { spawn } = require('child_process');
const path = require('path');

// Cargar variables de entorno
require('dotenv').config({ path: path.join(__dirname, '.env') });

class QBTCUnifiedLauncher {
    constructor() {
        this.systems = {
            smartProxy: { name: 'Smart Proxy', script: 'qbtc-smart-proxy.cjs', status: 'unknown' },
            socks5Proxy: { name: 'SOCKS5 Proxy', script: 'qbtc-socks5-proxy.cjs', status: 'unknown' },
            vpnConnector: { name: 'VPN Connector', script: 'qbtc-vpn-connector.cjs', status: 'unknown' },
            httpProxy: { name: 'HTTP Proxy', script: 'qbtc-with-correct-ip.cjs', status: 'unknown' },
            directConnection: { name: 'Direct Connection', script: 'system-integrator.cjs', status: 'unknown' }
        };

        this.currentProcess = null;
        this.monitorProcess = null;

        console.log('üöÄ QBTC UNIFIED LAUNCHER');
        console.log('========================');
        console.log('Sistema completo de proxy y VPN para QBTC');
        console.log('');
    }

    /**
     * Verificar si un script existe
     */
    scriptExists(scriptName) {
        const scriptPath = path.join(__dirname, scriptName);
        const fs = require('fs');
        return fs.existsSync(scriptPath);
    }

    /**
     * Probar un sistema espec√≠fico
     */
    async testSystem(systemKey) {
        const system = this.systems[systemKey];
        if (!system) return false;

        console.log(`üîç Probando ${system.name}...`);

        return new Promise((resolve) => {
            if (!this.scriptExists(system.script)) {
                console.log(`‚ùå Script ${system.script} no encontrado`);
                resolve(false);
                return;
            }

            const child = spawn('node', [system.script, '--status'], {
                cwd: __dirname,
                stdio: ['pipe', 'pipe', 'pipe'],
                timeout: 5000
            });

            let output = '';
            child.stdout.on('data', (data) => {
                output += data.toString();
            });

            child.on('close', (code) => {
                const success = code === 0;
                system.status = success ? 'available' : 'unavailable';
                console.log(`   ${system.name}: ${success ? '‚úÖ' : '‚ùå'}`);
                resolve(success);
            });

            child.on('error', () => {
                system.status = 'error';
                console.log(`   ${system.name}: ‚ùå (error)`);
                resolve(false);
            });

            // Timeout
            setTimeout(() => {
                child.kill();
                system.status = 'timeout';
                console.log(`   ${system.name}: ‚ùå (timeout)`);
                resolve(false);
            }, 5000);
        });
    }

    /**
     * Probar todos los sistemas
     */
    async testAllSystems() {
        console.log('üîç VERIFICANDO SISTEMAS DISPONIBLES');
        console.log('===================================');

        const results = {};
        for (const [key] of Object.entries(this.systems)) {
            results[key] = await this.testSystem(key);
        }

        console.log('\nüìä RESULTADOS:');
        Object.entries(results).forEach(([key, available]) => {
            const system = this.systems[key];
            console.log(`   ${available ? '‚úÖ' : '‚ùå'} ${system.name}`);
        });

        return results;
    }

    /**
     * Seleccionar mejor sistema disponible
     */
    async selectBestSystem() {
        console.log('\nüéØ SELECCIONANDO MEJOR SISTEMA');
        console.log('==============================');

        const results = await this.testAllSystems();

        // Estrategia de selecci√≥n por prioridad
        const priorityOrder = [
            'smartProxy',      // 1. Smart Proxy (m√°s avanzado)
            'socks5Proxy',     // 2. SOCKS5 (cambia IP real)
            'vpnConnector',    // 3. VPN (conexi√≥n dedicada)
            'httpProxy',       // 4. HTTP Proxy (headers)
            'directConnection' // 5. Direct (fallback)
        ];

        for (const systemKey of priorityOrder) {
            if (results[systemKey]) {
                const system = this.systems[systemKey];
                console.log(`‚úÖ Sistema seleccionado: ${system.name}`);
                return systemKey;
            }
        }

        console.log('‚ùå No hay sistemas disponibles');
        return null;
    }

    /**
     * Ejecutar sistema seleccionado
     */
    async executeSystem(systemKey) {
        const system = this.systems[systemKey];
        if (!system) {
            console.error('‚ùå Sistema no v√°lido');
            return false;
        }

        console.log(`\nüöÄ EJECUTANDO ${system.name.toUpperCase()}`);
        console.log('=====================================');

        return new Promise((resolve) => {
            this.currentProcess = spawn('node', [system.script], {
                cwd: __dirname,
                stdio: 'inherit',
                env: {
                    ...process.env,
                    LAUNCHED_BY_UNIFIED: 'true'
                }
            });

            this.currentProcess.on('close', (code) => {
                console.log(`\nüîÑ ${system.name} terminado con c√≥digo: ${code}`);
                this.currentProcess = null;
                resolve(code === 0);
            });

            this.currentProcess.on('error', (error) => {
                console.error(`‚ùå Error ejecutando ${system.name}:`, error);
                this.currentProcess = null;
                resolve(false);
            });
        });
    }

    /**
     * Iniciar monitor en background
     */
    startMonitor() {
        console.log('üìä Iniciando monitor en background...');

        if (this.scriptExists('qbtc-proxy-monitor.cjs')) {
            this.monitorProcess = spawn('node', ['qbtc-proxy-monitor.cjs', '--dashboard'], {
                cwd: __dirname,
                stdio: 'ignore',
                detached: true
            });

            this.monitorProcess.unref();

            console.log('‚úÖ Monitor iniciado: http://localhost:9099');
        } else {
            console.log('‚ö†Ô∏è Monitor no disponible');
        }
    }

    /**
     * Detener procesos
     */
    stopProcesses() {
        if (this.currentProcess) {
            console.log('üõë Deteniendo proceso actual...');
            this.currentProcess.kill();
        }

        if (this.monitorProcess) {
            console.log('üõë Deteniendo monitor...');
            this.monitorProcess.kill();
        }
    }

    /**
     * Mostrar men√∫ interactivo
     */
    async showMenu() {
        console.log('\nüéõÔ∏è QBTC UNIFIED LAUNCHER - MEN√ö');
        console.log('===============================');
        console.log('1. üöÄ Auto (mejor sistema disponible)');
        console.log('2. üß† Smart Proxy (inteligente)');
        console.log('3. üîí SOCKS5 Proxy (IP real)');
        console.log('4. üõ°Ô∏è VPN Connector (VPN)');
        console.log('5. üåê HTTP Proxy (headers)');
        console.log('6. üîó Direct Connection (sin proxy)');
        console.log('7. üìä Iniciar Monitor');
        console.log('8. üîç Verificar Sistemas');
        console.log('9. ‚öôÔ∏è Configurar Proxies');
        console.log('10. ‚ùå Salir');
        console.log('===============================');

        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const answer = await new Promise(resolve => {
            rl.question('Selecciona una opci√≥n (1-10): ', resolve);
        });

        rl.close();

        return answer.trim();
    }

    /**
     * Ejecutar configuraci√≥n
     */
    async runConfiguration() {
        console.log('\n‚öôÔ∏è EJECUTANDO CONFIGURACI√ìN');
        console.log('==========================');

        if (this.scriptExists('qbtc-proxy-config.cjs')) {
            const { spawn } = require('child_process');
            const configProcess = spawn('node', ['qbtc-proxy-config.cjs', '--interactive'], {
                stdio: 'inherit',
                cwd: __dirname
            });

            return new Promise((resolve) => {
                configProcess.on('close', (code) => {
                    console.log(`\nüîÑ Configuraci√≥n terminada con c√≥digo: ${code}`);
                    resolve(code === 0);
                });
            });
        } else {
            console.log('‚ùå Herramienta de configuraci√≥n no encontrada');
            return false;
        }
    }

    /**
     * Ejecutar men√∫ interactivo
     */
    async runInteractive() {
        console.log('üéØ Modo Interactivo Activado');
        console.log('===========================');

        while (true) {
            const choice = await this.showMenu();

            try {
                switch (choice) {
                    case '1':
                        console.log('\nüöÄ Ejecutando modo AUTO...');
                        const bestSystem = await this.selectBestSystem();
                        if (bestSystem) {
                            await this.executeSystem(bestSystem);
                        }
                        break;

                    case '2':
                        console.log('\nüß† Ejecutando Smart Proxy...');
                        await this.executeSystem('smartProxy');
                        break;

                    case '3':
                        console.log('\nüîí Ejecutando SOCKS5 Proxy...');
                        await this.executeSystem('socks5Proxy');
                        break;

                    case '4':
                        console.log('\nüõ°Ô∏è Ejecutando VPN Connector...');
                        await this.executeSystem('vpnConnector');
                        break;

                    case '5':
                        console.log('\nüåê Ejecutando HTTP Proxy...');
                        await this.executeSystem('httpProxy');
                        break;

                    case '6':
                        console.log('\nüîó Ejecutando Direct Connection...');
                        await this.executeSystem('directConnection');
                        break;

                    case '7':
                        console.log('\nüìä Iniciando Monitor...');
                        this.startMonitor();
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        break;

                    case '8':
                        console.log('\nüîç Verificando sistemas...');
                        await this.testAllSystems();
                        break;

                    case '9':
                        console.log('\n‚öôÔ∏è Iniciando configuraci√≥n...');
                        await this.runConfiguration();
                        break;

                    case '10':
                        console.log('\nüëã ¬°Hasta luego!');
                        this.stopProcesses();
                        return;

                    default:
                        console.log('\n‚ùå Opci√≥n no v√°lida');
                }
            } catch (error) {
                console.error('\n‚ùå Error:', error.message);
            }

            // Pausa antes de mostrar men√∫ nuevamente
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }

    /**
     * Ejecutar modo autom√°tico
     */
    async runAuto() {
        console.log('üöÄ MODO AUTOM√ÅTICO');
        console.log('==================');

        // Iniciar monitor en background
        this.startMonitor();

        // Esperar un poco para que el monitor inicie
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Seleccionar y ejecutar mejor sistema
        const bestSystem = await this.selectBestSystem();

        if (bestSystem) {
            console.log(`\nüéØ Sistema √≥ptimo encontrado: ${this.systems[bestSystem].name}`);
            await this.executeSystem(bestSystem);
        } else {
            console.log('\n‚ùå No se pudo encontrar un sistema operativo');
            console.log('üí° Sugerencias:');
            console.log('   ‚Ä¢ Ejecuta: node qbtc-proxy-config.cjs --interactive');
            console.log('   ‚Ä¢ Configura un proveedor de proxy');
            console.log('   ‚Ä¢ Verifica las credenciales de Binance');
        }
    }

    /**
     * Ejecutar modo espec√≠fico
     */
    async runSpecific(systemKey) {
        console.log(`üéØ MODO ESPEC√çFICO: ${systemKey.toUpperCase()}`);
        console.log('==================');

        if (!this.systems[systemKey]) {
            console.error(`‚ùå Sistema '${systemKey}' no encontrado`);
            console.log('Sistemas disponibles:', Object.keys(this.systems).join(', '));
            return;
        }

        // Verificar si el sistema est√° disponible
        const available = await this.testSystem(systemKey);
        if (!available) {
            console.error(`‚ùå Sistema '${systemKey}' no est√° disponible`);
            return;
        }

        await this.executeSystem(systemKey);
    }
}

// Funci√≥n para mostrar informaci√≥n del sistema
function showSystemInfo() {
    console.log('‚ÑπÔ∏è  INFORMACI√ìN DEL SISTEMA QBTC UNIFIED');
    console.log('======================================');
    console.log('Sistemas disponibles:');
    console.log('  üß† Smart Proxy - Proxy inteligente con rotaci√≥n');
    console.log('  üîí SOCKS5 Proxy - Cambia IP real de conexi√≥n');
    console.log('  üõ°Ô∏è VPN Connector - Conexi√≥n VPN autom√°tica');
    console.log('  üåê HTTP Proxy - Modifica headers HTTP');
    console.log('  üîó Direct Connection - Conexi√≥n sin proxy');
    console.log('');
    console.log('Herramientas adicionales:');
    console.log('  üìä Proxy Monitor - Dashboard de monitoreo');
    console.log('  ‚öôÔ∏è Proxy Config - Configuraci√≥n interactiva');
    console.log('  üéõÔ∏è Master Launcher - Selector inteligente');
    console.log('');
}

// Si se ejecuta directamente
if (require.main === module) {
    const args = process.argv.slice(2);
    const launcher = new QBTCUnifiedLauncher();

    if (args.includes('--auto') || args.includes('-a')) {
        // Modo autom√°tico
        launcher.runAuto();
    } else if (args.includes('--interactive') || args.includes('-i')) {
        // Modo interactivo
        launcher.runInteractive();
    } else if (args.includes('--monitor') || args.includes('-m')) {
        // Solo iniciar monitor
        launcher.startMonitor();
        console.log('üìä Monitor iniciado. Presiona Ctrl+C para detener.');
    } else if (args.includes('--test') || args.includes('-t')) {
        // Solo probar sistemas
        launcher.testAllSystems();
    } else if (args.length > 0 && !args[0].startsWith('-')) {
        // Sistema espec√≠fico
        const systemKey = args[0];
        launcher.runSpecific(systemKey);
    } else {
        // Mostrar ayuda
        showSystemInfo();
        console.log('üéõÔ∏è QBTC UNIFIED LAUNCHER');
        console.log('========================');
        console.log('Uso:');
        console.log('  node qbtc-unified-launcher.cjs --auto         # Modo autom√°tico');
        console.log('  node qbtc-unified-launcher.cjs --interactive  # Modo interactivo');
        console.log('  node qbtc-unified-launcher.cjs --monitor      # Solo monitor');
        console.log('  node qbtc-unified-launcher.cjs --test         # Probar sistemas');
        console.log('  node qbtc-unified-launcher.cjs [sistema]      # Sistema espec√≠fico');
        console.log('  node qbtc-unified-launcher.cjs                # Esta ayuda');
        console.log('');
        console.log('Sistemas disponibles:');
        console.log('  smartProxy, socks5Proxy, vpnConnector, httpProxy, directConnection');
        console.log('');
        console.log('Ejemplos:');
        console.log('  node qbtc-unified-launcher.cjs smartProxy     # Ejecutar Smart Proxy');
        console.log('  node qbtc-unified-launcher.cjs --auto         # Mejor opci√≥n autom√°tica');
        console.log('  node qbtc-unified-launcher.cjs --interactive  # Men√∫ interactivo');
        process.exit(0);
    }

    // Manejar se√±ales de terminaci√≥n
    process.on('SIGINT', () => {
        console.log('\nüîÑ Unified Launcher detenido por SIGINT');
        launcher.stopProcesses();
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log('\nüîÑ Unified Launcher detenido por SIGTERM');
        launcher.stopProcesses();
        process.exit(0);
    });
}

// Exportar la clase
module.exports = { QBTCUnifiedLauncher };