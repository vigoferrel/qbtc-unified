#!/usr/bin/env node

/**
 * QBTC MASTER SYSTEM
 * Sistema maestro que integra toda la infraestructura VPN y Proxy
 * Ejecuta desde cualquier ubicaci√≥n y selecciona autom√°ticamente el mejor sistema
 */

const path = require('path');
const fs = require('fs');

class QBTCMasterSystem {
    constructor() {
        this.projectRoot = this.findProjectRoot();
        this.systems = {};
        this.status = {
            initialized: false,
            currentIP: null,
            ipAuthorized: false,
            bestSystem: null,
            activeSystem: null
        };

        console.log('üåü QBTC MASTER SYSTEM');
        console.log('====================');
        console.log('Sistema maestro unificado para VPN y Proxies');
        console.log('');
    }

    /**
     * Encontrar la ra√≠z del proyecto
     */
    findProjectRoot() {
        let currentDir = __dirname;

        // Buscar hacia arriba hasta encontrar package.json o .env
        for (let i = 0; i < 10; i++) {
            if (fs.existsSync(path.join(currentDir, 'package.json')) ||
                fs.existsSync(path.join(currentDir, '.env'))) {
                return currentDir;
            }
            const parentDir = path.dirname(currentDir);
            if (parentDir === currentDir) break; // Llegamos a la ra√≠z
            currentDir = parentDir;
        }

        return __dirname; // Fallback
    }

    /**
     * Verificar si un archivo existe
     */
    fileExists(filePath) {
        try {
            return fs.existsSync(path.join(this.projectRoot, filePath));
        } catch {
            return false;
        }
    }

    /**
     * Importar m√≥dulo de forma segura
     */
    async safeImport(modulePath) {
        try {
            const fullPath = path.join(this.projectRoot, modulePath);
            if (fs.existsSync(fullPath)) {
                const module = require(fullPath);
                return module;
            }
        } catch (error) {
            console.log(`‚ö†Ô∏è No se pudo importar ${modulePath}:`, error.message);
        }
        return null;
    }

    /**
     * Inicializar todos los sistemas disponibles
     */
    async initializeSystems() {
        console.log('üöÄ Inicializando sistemas disponibles...');

        // Sistemas de la infraestructura existente (carpeta opciones)
        const existingSystems = [
            { key: 'dualVPN', path: '../opciones/vpn-config/dual-vpn-solution.js', name: 'Dual VPN (cu√°ntico)' },
            { key: 'basicVPN', path: '../opciones/qbtc-vpn-solution.js', name: 'Basic VPN' }
        ];

        // Sistemas nuevos (carpeta actual)
        const newSystems = [
            { key: 'smartProxy', path: 'qbtc-smart-proxy.cjs', name: 'Smart Proxy' },
            { key: 'socks5Proxy', path: 'qbtc-socks5-proxy.cjs', name: 'SOCKS5 Proxy' },
            { key: 'vpnConnector', path: 'qbtc-vpn-connector.cjs', name: 'VPN Connector' },
            { key: 'httpProxy', path: 'qbtc-with-correct-ip.cjs', name: 'HTTP Proxy' },
            { key: 'unifiedLauncher', path: 'qbtc-unified-launcher.cjs', name: 'Unified Launcher' },
            { key: 'proxyMonitor', path: 'qbtc-proxy-monitor.cjs', name: 'Proxy Monitor' }
        ];

        const allSystems = [...existingSystems, ...newSystems];

        for (const system of allSystems) {
            const module = await this.safeImport(system.path);
            if (module) {
                this.systems[system.key] = {
                    name: system.name,
                    module: module,
                    instance: null,
                    available: true
                };
                console.log(`‚úÖ ${system.name} disponible`);
            } else {
                this.systems[system.key] = {
                    name: system.name,
                    available: false
                };
                console.log(`‚ùå ${system.name} no disponible`);
            }
        }

        console.log('‚úÖ Inicializaci√≥n completa');
        this.status.initialized = true;
    }

    /**
     * Obtener IP actual
     */
    async getCurrentIP() {
        try {
            const https = require('https');
            return new Promise((resolve) => {
                https.get('https://api.ipify.org', (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => {
                        const ip = data.trim();
                        this.status.currentIP = ip;
                        resolve(ip);
                    });
                }).on('error', () => resolve('unknown'));
            });
        } catch {
            return 'unknown';
        }
    }

    /**
     * Verificar si IP est√° autorizada
     */
    isIPAuthorized(ip) {
        const authorizedIPs = [
            '181.43.212.196',  // IP objetivo principal
            '192.168.173.160', // IP OpenVPN del sistema dual
            '10.5.0.2',        // IP adicional
            '172.16.42.223'    // IP adicional
        ];

        const authorized = authorizedIPs.includes(ip);
        this.status.ipAuthorized = authorized;
        return authorized;
    }

    /**
     * Probar un sistema espec√≠fico
     */
    async testSystem(systemKey) {
        const system = this.systems[systemKey];
        if (!system || !system.available) return false;

        try {
            console.log(`üîç Probando ${system.name}...`);

            // Crear instancia si es posible
            if (system.module) {
                const SystemClass = system.module[Object.keys(system.module)[0]];
                if (SystemClass) {
                    system.instance = new SystemClass();
                }
            }

            // Si tiene m√©todo de verificaci√≥n, usarlo
            if (system.instance && typeof system.instance.getSystemState === 'function') {
                await system.instance.getSystemState();
                return true;
            }

            // Si tiene m√©todo initialize, probarlo
            if (system.instance && typeof system.instance.initialize === 'function') {
                await system.instance.initialize();
                return true;
            }

            // Si llega aqu√≠, asumir que est√° disponible
            return true;

        } catch (error) {
            console.log(`‚ùå Error probando ${system.name}:`, error.message);
            return false;
        }
    }

    /**
     * Seleccionar mejor sistema disponible
     */
    async selectBestSystem() {
        console.log('üéØ Seleccionando mejor sistema disponible...');

        // Verificar IP actual
        const currentIP = await this.getCurrentIP();
        console.log(`üì° IP actual: ${currentIP}`);
        console.log(`‚úÖ Autorizada: ${this.isIPAuthorized(currentIP) ? 'S√ç' : 'NO'}`);

        // Si IP ya est√° autorizada, usar sistema directo
        if (this.status.ipAuthorized) {
            console.log('üéâ IP ya autorizada - sistema directo recomendado');
            this.status.bestSystem = 'direct';
            return 'direct';
        }

        // Probar sistemas por orden de prioridad
        const priorityOrder = [
            'dualVPN',       // 1. M√°s avanzado (cu√°ntico)
            'smartProxy',    // 2. Rotaci√≥n autom√°tica
            'socks5Proxy',   // 3. SOCKS5 (cambia IP real)
            'vpnConnector',  // 4. VPN autom√°tica
            'basicVPN',      // 5. VPN b√°sica
            'httpProxy',     // 6. HTTP proxy
            'unifiedLauncher' // 7. Selector inteligente
        ];

        for (const systemKey of priorityOrder) {
            if (await this.testSystem(systemKey)) {
                const system = this.systems[systemKey];
                console.log(`‚úÖ Sistema seleccionado: ${system.name}`);
                this.status.bestSystem = systemKey;
                return systemKey;
            }
        }

        console.log('‚ùå No se encontr√≥ un sistema operativo');
        return null;
    }

    /**
     * Ejecutar sistema seleccionado
     */
    async executeSystem(systemKey) {
        if (systemKey === 'direct') {
            console.log('‚úÖ Usando conexi√≥n directa (IP ya autorizada)');
            console.log('üéØ Ejecuta: node system-integrator.cjs');
            return true;
        }

        const system = this.systems[systemKey];
        if (!system || !system.available) {
            console.error(`‚ùå Sistema ${systemKey} no disponible`);
            return false;
        }

        console.log(`üöÄ Ejecutando ${system.name}...`);

        try {
            if (system.instance) {
                // Ejecutar m√©todo principal seg√∫n el sistema
                if (typeof system.instance.initialize === 'function') {
                    await system.instance.initialize();
                } else if (typeof system.instance.runIntegratedSystem === 'function') {
                    await system.instance.runIntegratedSystem();
                } else if (typeof system.instance.runAuto === 'function') {
                    await system.instance.runAuto();
                } else if (typeof system.instance.initializeSystem === 'function') {
                    await system.instance.initializeSystem();
                } else {
                    console.log(`‚ö†Ô∏è Sistema ${system.name} no tiene m√©todo de ejecuci√≥n definido`);
                }
            } else {
                console.log(`‚ö†Ô∏è No se pudo crear instancia de ${system.name}`);
            }

            this.status.activeSystem = systemKey;
            console.log(`‚úÖ ${system.name} ejecutado exitosamente`);
            return true;

        } catch (error) {
            console.error(`‚ùå Error ejecutando ${system.name}:`, error.message);
            return false;
        }
    }

    /**
     * Ejecutar sistema maestro completo
     */
    async runMasterSystem() {
        try {
            console.log('üåü EJECUTANDO SISTEMA MAESTRO QBTC');
            console.log('=================================');

            // 1. Inicializar sistemas
            await this.initializeSystems();

            // 2. Seleccionar mejor sistema
            const selectedSystem = await this.selectBestSystem();

            if (!selectedSystem) {
                console.log('‚ùå No hay sistemas disponibles');
                console.log('üí° Soluciones:');
                console.log('   ‚Ä¢ Verifica la instalaci√≥n de Node.js');
                console.log('   ‚Ä¢ Configura proveedores de proxy en .env');
                console.log('   ‚Ä¢ Instala clientes VPN (OpenVPN, NordVPN, etc.)');
                return false;
            }

            // 3. Ejecutar sistema seleccionado
            const success = await this.executeSystem(selectedSystem);

            if (success) {
                console.log('üéâ SISTEMA MAESTRO EJECUTADO EXITOSAMENTE');
                console.log('========================================');

                const finalIP = await this.getCurrentIP();
                console.log('üìä Estado final:');
                console.log(`   üåê IP actual: ${finalIP}`);
                console.log(`   ‚úÖ IP autorizada: ${this.isIPAuthorized(finalIP) ? 'S√ç' : 'NO'}`);
                console.log(`   üîß Sistema usado: ${this.status.activeSystem || 'Directo'}`);

                return true;
            } else {
                console.log('‚ùå Error en la ejecuci√≥n del sistema');
                return false;
            }

        } catch (error) {
            console.error('‚ùå Error en sistema maestro:', error.message);
            return false;
        }
    }

    /**
     * Mostrar men√∫ interactivo
     */
    async showMenu() {
        console.log('\nüéõÔ∏è QBTC MASTER SYSTEM - MEN√ö');
        console.log('===========================');
        console.log('1. üöÄ Ejecutar sistema autom√°tico');
        console.log('2. üß† Sistema Dual VPN (cu√°ntico)');
        console.log('3. üîß Sistema Basic VPN');
        console.log('4. üß† Smart Proxy (rotaci√≥n)');
        console.log('5. üîí SOCKS5 Proxy');
        console.log('6. üõ°Ô∏è VPN Connector');
        console.log('7. üåê HTTP Proxy');
        console.log('8. üéõÔ∏è Unified Launcher');
        console.log('9. üìä Ver estado');
        console.log('10. üîç Verificar sistemas');
        console.log('11. ‚ùå Salir');
        console.log('===========================');

        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const answer = await new Promise(resolve => {
            rl.question('Selecciona una opci√≥n (1-11): ', resolve);
        });

        rl.close();

        return answer.trim();
    }

    /**
     * Ejecutar men√∫ interactivo
     */
    async runInteractive() {
        console.log('üéØ MODO INTERACTIVO ACTIVADO');
        console.log('===========================');

        // Inicializar sistemas
        await this.initializeSystems();

        while (true) {
            const choice = await this.showMenu();

            try {
                switch (choice) {
                    case '1':
                        console.log('\nüöÄ Ejecutando sistema autom√°tico...');
                        await this.runMasterSystem();
                        break;

                    case '2':
                        await this.executeSystem('dualVPN');
                        break;

                    case '3':
                        await this.executeSystem('basicVPN');
                        break;

                    case '4':
                        await this.executeSystem('smartProxy');
                        break;

                    case '5':
                        await this.executeSystem('socks5Proxy');
                        break;

                    case '6':
                        await this.executeSystem('vpnConnector');
                        break;

                    case '7':
                        await this.executeSystem('httpProxy');
                        break;

                    case '8':
                        await this.executeSystem('unifiedLauncher');
                        break;

                    case '9':
                        console.log('\nüìä Estado del sistema:');
                        console.log(`   Inicializado: ${this.status.initialized}`);
                        console.log(`   IP actual: ${this.status.currentIP || 'Desconocida'}`);
                        console.log(`   IP autorizada: ${this.status.ipAuthorized ? 'S√ç' : 'NO'}`);
                        console.log(`   Mejor sistema: ${this.status.bestSystem || 'Ninguno'}`);
                        console.log(`   Sistema activo: ${this.status.activeSystem || 'Ninguno'}`);
                        break;

                    case '10':
                        console.log('\nüîç Verificando sistemas disponibles...');
                        await this.initializeSystems();
                        break;

                    case '11':
                        console.log('\nüëã ¬°Hasta luego!');
                        return;

                    default:
                        console.log('\n‚ùå Opci√≥n no v√°lida');
                }
            } catch (error) {
                console.error('\n‚ùå Error:', error.message);
            }

            // Pausa antes de mostrar men√∫ nuevamente
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }

    /**
     * Obtener estado completo
     */
    getStatus() {
        return {
            ...this.status,
            systems: Object.entries(this.systems).map(([key, system]) => ({
                key,
                name: system.name,
                available: system.available
            })),
            projectRoot: this.projectRoot,
            timestamp: new Date().toISOString()
        };
    }
}

// Funci√≥n para mostrar informaci√≥n del sistema
function showSystemInfo() {
    console.log('‚ÑπÔ∏è  QBTC MASTER SYSTEM');
    console.log('=====================');
    console.log('Sistema maestro que integra toda la infraestructura:');
    console.log('');
    console.log('üèóÔ∏è INFRAESTRUCTURA EXISTENTE:');
    console.log('  üß† Dual VPN Solution - VPN cu√°ntico avanzado');
    console.log('  üîß Basic VPN Solution - VPN simple');
    console.log('  üìä Quantum Constants - Constantes unificadas');
    console.log('');
    console.log('üÜï SISTEMAS NUEVOS:');
    console.log('  üß† Smart Proxy - Rotaci√≥n autom√°tica');
    console.log('  üîí SOCKS5 Proxy - Cambio IP real');
    console.log('  üõ°Ô∏è VPN Connector - VPN autom√°tica');
    console.log('  üåê HTTP Proxy - Headers forzados');
    console.log('  üéõÔ∏è Unified Launcher - Selector inteligente');
    console.log('  üìä Proxy Monitor - Dashboard web');
    console.log('');
    console.log('üéØ CARACTER√çSTICAS:');
    console.log('  ‚úÖ Detecci√≥n autom√°tica de ubicaci√≥n');
    console.log('  ‚úÖ Selecci√≥n inteligente de m√©todo');
    console.log('  ‚úÖ Fallback autom√°tico');
    console.log('  ‚úÖ Integraci√≥n completa');
    console.log('  ‚úÖ Ejecuci√≥n desde cualquier lugar');
    console.log('');
}

// Si se ejecuta directamente
if (require.main === module) {
    const args = process.argv.slice(2);
    const masterSystem = new QBTCMasterSystem();

    if (args.includes('--auto') || args.includes('-a')) {
        // Modo autom√°tico
        masterSystem.runMasterSystem();
    } else if (args.includes('--interactive') || args.includes('-i')) {
        // Modo interactivo
        masterSystem.runInteractive();
    } else if (args.includes('--status') || args.includes('-s')) {
        // Solo estado
        masterSystem.initializeSystems().then(async () => {
            const status = await masterSystem.getStatus();
            console.log(JSON.stringify(status, null, 2));
        });
    } else {
        // Mostrar ayuda
        showSystemInfo();
        console.log('üéõÔ∏è QBTC MASTER SYSTEM');
        console.log('====================');
        console.log('Uso:');
        console.log('  node qbtc-master-system.cjs --auto         # Autom√°tico');
        console.log('  node qbtc-master-system.cjs --interactive  # Interactivo');
        console.log('  node qbtc-master-system.cjs --status       # Estado');
        console.log('  node qbtc-master-system.cjs                # Esta ayuda');
        console.log('');
        console.log('Ejemplos:');
        console.log('  node qbtc-master-system.cjs --auto         # Sistema completo');
        console.log('  node qbtc-master-system.cjs --interactive  # Men√∫ completo');
        process.exit(0);
    }

    // Manejar se√±ales de terminaci√≥n
    process.on('SIGINT', () => {
        console.log('\nüîÑ Master System detenido por SIGINT');
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log('\nüîÑ Master System detenido por SIGTERM');
        process.exit(0);
    });
}

// Exportar la clase
module.exports = { QBTCMasterSystem };