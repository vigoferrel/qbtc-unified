#!/usr/bin/env node

/**
 * QBTC INTEGRATED VPN SYSTEM
 * Sistema integrado que combina la infraestructura existente avanzada
 * con las nuevas implementaciones de proxy y monitoreo
 */

const path = require('path');
const fs = require('fs');

// Importar sistemas existentes
let DualVPNSolution;
let QBTCVPNSolution;
let QBTCSmartProxy;
let QBTCProxyMonitor;
let QBTCUnifiedLauncher;

try {
    // Importar desde la infraestructura existente
    DualVPNSolution = require(path.join(__dirname, '../opciones/vpn-config/dual-vpn-solution.js'));
    QBTCVPNSolution = require(path.join(__dirname, '../opciones/qbtc-vpn-solution.js'));
} catch (error) {
    console.log('‚ö†Ô∏è Infraestructura existente no encontrada, usando solo sistemas nuevos');
}

try {
    // Importar sistemas nuevos
    QBTCSmartProxy = require('./qbtc-smart-proxy.cjs');
    QBTCProxyMonitor = require('./qbtc-proxy-monitor.cjs');
    QBTCUnifiedLauncher = require('./qbtc-unified-launcher.cjs');
} catch (error) {
    console.log('‚ö†Ô∏è Algunos sistemas nuevos no encontrados');
}

class QBTCIntegratedVPNSystem {
    constructor() {
        this.systems = {
            dualVPN: null,
            basicVPN: null,
            smartProxy: null,
            proxyMonitor: null,
            unifiedLauncher: null
        };

        this.status = {
            initialized: false,
            activeSystem: null,
            ipAuthorized: false,
            lastCheck: Date.now()
        };

        console.log('üîß QBTC INTEGRATED VPN SYSTEM');
        console.log('=============================');
        console.log('Sistema unificado que combina:');
        console.log('  üß† Dual VPN Solution (existente)');
        console.log('  üîß Basic VPN Solution (existente)');
        console.log('  üß† Smart Proxy System (nuevo)');
        console.log('  üìä Proxy Monitor (nuevo)');
        console.log('  üéõÔ∏è Unified Launcher (nuevo)');
        console.log('');
    }

    /**
     * Inicializar sistemas disponibles
     */
    async initializeSystems() {
        console.log('üöÄ INICIALIZANDO SISTEMAS DISPONIBLES...');

        // Inicializar Dual VPN (sistema m√°s avanzado existente)
        if (DualVPNSolution) {
            try {
                this.systems.dualVPN = new DualVPNSolution();
                console.log('‚úÖ Dual VPN System inicializado');
            } catch (error) {
                console.log('‚ùå Error inicializando Dual VPN:', error.message);
            }
        }

        // Inicializar Basic VPN
        if (QBTCVPNSolution) {
            try {
                this.systems.basicVPN = new QBTCVPNSolution();
                console.log('‚úÖ Basic VPN System inicializado');
            } catch (error) {
                console.log('‚ùå Error inicializando Basic VPN:', error.message);
            }
        }

        // Inicializar Smart Proxy (nuevo)
        if (QBTCSmartProxy) {
            try {
                this.systems.smartProxy = new QBTCSmartProxy.QBTCSmartProxy();
                console.log('‚úÖ Smart Proxy System inicializado');
            } catch (error) {
                console.log('‚ùå Error inicializando Smart Proxy:', error.message);
            }
        }

        // Inicializar Proxy Monitor
        if (QBTCProxyMonitor) {
            try {
                this.systems.proxyMonitor = new QBTCProxyMonitor.QBTCProxyMonitor();
                console.log('‚úÖ Proxy Monitor inicializado');
            } catch (error) {
                console.log('‚ùå Error inicializando Proxy Monitor:', error.message);
            }
        }

        // Inicializar Unified Launcher
        if (QBTCUnifiedLauncher) {
            try {
                this.systems.unifiedLauncher = new QBTCUnifiedLauncher.QBTCUnifiedLauncher();
                console.log('‚úÖ Unified Launcher inicializado');
            } catch (error) {
                console.log('‚ùå Error inicializando Unified Launcher:', error.message);
            }
        }

        this.status.initialized = true;
        console.log('‚úÖ Inicializaci√≥n completa');
    }

    /**
     * Verificar IP actual
     */
    async checkCurrentIP() {
        try {
            const https = require('https');
            return new Promise((resolve, reject) => {
                https.get('https://api.ipify.org', (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => resolve(data.trim()));
                }).on('error', reject);
            });
        } catch (error) {
            return 'unknown';
        }
    }

    /**
     * Verificar si IP est√° autorizada
     */
    isIPAuthorized(ip) {
        const authorizedIPs = [
            '181.43.212.196',  // IP objetivo principal
            '192.168.173.160', // IP OpenVPN del sistema dual
            '10.5.0.2',        // IP adicional
            '172.16.42.223'    // IP adicional
        ];
        return authorizedIPs.includes(ip);
    }

    /**
     * Seleccionar mejor sistema disponible
     */
    async selectBestSystem() {
        console.log('üéØ SELECCIONANDO MEJOR SISTEMA...');

        const currentIP = await this.checkCurrentIP();
        this.status.ipAuthorized = this.isIPAuthorized(currentIP);

        console.log(`üì° IP actual: ${currentIP}`);
        console.log(`‚úÖ Autorizada: ${this.status.ipAuthorized ? 'S√ç' : 'NO'}`);

        // Si IP ya est√° autorizada, usar sistema directo
        if (this.status.ipAuthorized) {
            console.log('üéâ IP ya autorizada - usando sistema directo');
            return 'direct';
        }

        // Estrategia de selecci√≥n por prioridad
        const priorityOrder = [
            { key: 'dualVPN', name: 'Dual VPN (cu√°ntico)', system: this.systems.dualVPN },
            { key: 'smartProxy', name: 'Smart Proxy', system: this.systems.smartProxy },
            { key: 'basicVPN', name: 'Basic VPN', system: this.systems.basicVPN },
            { key: 'unifiedLauncher', name: 'Unified Launcher', system: this.systems.unifiedLauncher }
        ];

        for (const option of priorityOrder) {
            if (option.system) {
                console.log(`‚úÖ Sistema seleccionado: ${option.name}`);
                this.status.activeSystem = option.key;
                return option.key;
            }
        }

        console.log('‚ùå No hay sistemas disponibles');
        return null;
    }

    /**
     * Ejecutar sistema seleccionado
     */
    async executeSelectedSystem(systemKey) {
        const system = this.systems[systemKey];

        if (!system) {
            console.error(`‚ùå Sistema ${systemKey} no disponible`);
            return false;
        }

        console.log(`üöÄ EJECUTANDO SISTEMA: ${systemKey.toUpperCase()}`);

        try {
            switch (systemKey) {
                case 'dualVPN':
                    await system.initialize();
                    break;

                case 'basicVPN':
                    await system.runVPNSolution();
                    break;

                case 'smartProxy':
                    await system.initializeSystem();
                    break;

                case 'unifiedLauncher':
                    await system.runAuto();
                    break;

                case 'direct':
                    console.log('‚úÖ Usando conexi√≥n directa (IP ya autorizada)');
                    return true;

                default:
                    console.log('‚ùå Sistema no reconocido');
                    return false;
            }

            console.log(`‚úÖ Sistema ${systemKey} ejecutado exitosamente`);
            return true;

        } catch (error) {
            console.error(`‚ùå Error ejecutando ${systemKey}:`, error.message);
            return false;
        }
    }

    /**
     * Iniciar monitor si est√° disponible
     */
    async startMonitor() {
        if (this.systems.proxyMonitor) {
            try {
                this.systems.proxyMonitor.startServer();
                console.log('üìä Monitor iniciado en background');
            } catch (error) {
                console.log('‚ö†Ô∏è Error iniciando monitor:', error.message);
            }
        }
    }

    /**
     * Obtener estado completo del sistema
     */
    async getSystemStatus() {
        const currentIP = await this.checkCurrentIP();

        return {
            initialized: this.status.initialized,
            currentIP: currentIP,
            ipAuthorized: this.isIPAuthorized(currentIP),
            activeSystem: this.status.activeSystem,
            availableSystems: Object.keys(this.systems).filter(key => this.systems[key] !== null),
            lastCheck: new Date().toISOString(),
            systems: {
                dualVPN: !!this.systems.dualVPN,
                basicVPN: !!this.systems.basicVPN,
                smartProxy: !!this.systems.smartProxy,
                proxyMonitor: !!this.systems.proxyMonitor,
                unifiedLauncher: !!this.systems.unifiedLauncher
            }
        };
    }

    /**
     * Ejecutar sistema integrado completo
     */
    async runIntegratedSystem() {
        try {
            console.log('üåü EJECUTANDO SISTEMA INTEGRADO QBTC');
            console.log('====================================');

            // 1. Inicializar sistemas
            await this.initializeSystems();

            // 2. Iniciar monitor en background
            await this.startMonitor();

            // 3. Seleccionar mejor sistema
            const selectedSystem = await this.selectBestSystem();

            if (!selectedSystem) {
                console.log('‚ùå No se pudo seleccionar un sistema operativo');
                console.log('üí° Verifica la configuraci√≥n de VPN y proxies');
                return false;
            }

            // 4. Ejecutar sistema seleccionado
            const success = await this.executeSelectedSystem(selectedSystem);

            if (success) {
                console.log('üéâ SISTEMA INTEGRADO EJECUTADO EXITOSAMENTE');
                console.log('==========================================');

                const finalStatus = await this.getSystemStatus();
                console.log('üìä Estado final:');
                console.log(`   üåê IP: ${finalStatus.currentIP}`);
                console.log(`   ‚úÖ Autorizada: ${finalStatus.ipAuthorized ? 'S√ç' : 'NO'}`);
                console.log(`   üîß Sistema activo: ${finalStatus.activeSystem || 'Ninguno'}`);
                console.log(`   üì¶ Sistemas disponibles: ${finalStatus.availableSystems.length}`);

                return true;
            } else {
                console.log('‚ùå Error en la ejecuci√≥n del sistema');
                return false;
            }

        } catch (error) {
            console.error('‚ùå Error en sistema integrado:', error.message);
            return false;
        }
    }

    /**
     * Mostrar men√∫ interactivo
     */
    async showInteractiveMenu() {
        console.log('\nüéõÔ∏è QBTC INTEGRATED VPN SYSTEM - MEN√ö');
        console.log('====================================');
        console.log('1. üöÄ Ejecutar sistema autom√°tico');
        console.log('2. üß† Usar Dual VPN (cu√°ntico)');
        console.log('3. üîß Usar Basic VPN');
        console.log('4. üß† Usar Smart Proxy');
        console.log('5. üéõÔ∏è Usar Unified Launcher');
        console.log('6. üìä Ver estado del sistema');
        console.log('7. üîç Verificar sistemas disponibles');
        console.log('8. ‚öôÔ∏è Configurar proxies');
        console.log('9. ‚ùå Salir');
        console.log('====================================');

        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        const answer = await new Promise(resolve => {
            rl.question('Selecciona una opci√≥n (1-9): ', resolve);
        });

        rl.close();

        return answer.trim();
    }

    /**
     * Ejecutar men√∫ interactivo
     */
    async runInteractive() {
        console.log('üéØ MODO INTERACTIVO ACTIVADO');
        console.log('===========================');

        // Inicializar sistemas al inicio
        await this.initializeSystems();

        while (true) {
            const choice = await this.showInteractiveMenu();

            try {
                switch (choice) {
                    case '1':
                        console.log('\nüöÄ Ejecutando sistema autom√°tico...');
                        await this.runIntegratedSystem();
                        break;

                    case '2':
                        if (this.systems.dualVPN) {
                            console.log('\nüß† Ejecutando Dual VPN...');
                            await this.executeSelectedSystem('dualVPN');
                        } else {
                            console.log('\n‚ùå Dual VPN no disponible');
                        }
                        break;

                    case '3':
                        if (this.systems.basicVPN) {
                            console.log('\nüîß Ejecutando Basic VPN...');
                            await this.executeSelectedSystem('basicVPN');
                        } else {
                            console.log('\n‚ùå Basic VPN no disponible');
                        }
                        break;

                    case '4':
                        if (this.systems.smartProxy) {
                            console.log('\nüß† Ejecutando Smart Proxy...');
                            await this.executeSelectedSystem('smartProxy');
                        } else {
                            console.log('\n‚ùå Smart Proxy no disponible');
                        }
                        break;

                    case '5':
                        if (this.systems.unifiedLauncher) {
                            console.log('\nüéõÔ∏è Ejecutando Unified Launcher...');
                            await this.executeSelectedSystem('unifiedLauncher');
                        } else {
                            console.log('\n‚ùå Unified Launcher no disponible');
                        }
                        break;

                    case '6':
                        console.log('\nüìä Estado del sistema:');
                        const status = await this.getSystemStatus();
                        console.log(JSON.stringify(status, null, 2));
                        break;

                    case '7':
                        console.log('\nüîç Verificando sistemas disponibles...');
                        await this.initializeSystems();
                        break;

                    case '8':
                        console.log('\n‚öôÔ∏è Ejecutando configuraci√≥n...');
                        // Aqu√≠ podr√≠amos integrar el configurador
                        console.log('üí° Funci√≥n de configuraci√≥n pr√≥ximamente');
                        break;

                    case '9':
                        console.log('\nüëã ¬°Hasta luego!');
                        return;

                    default:
                        console.log('\n‚ùå Opci√≥n no v√°lida');
                }
            } catch (error) {
                console.error('\n‚ùå Error:', error.message);
            }

            // Pausa antes de mostrar men√∫ nuevamente
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
}

// Funci√≥n para mostrar informaci√≥n del sistema
function showSystemInfo() {
    console.log('‚ÑπÔ∏è  QBTC INTEGRATED VPN SYSTEM');
    console.log('==============================');
    console.log('Sistema unificado que combina:');
    console.log('');
    console.log('üèóÔ∏è INFRAESTRUCTURA EXISTENTE:');
    console.log('  üß† Dual VPN Solution - VPN cu√°ntico avanzado');
    console.log('  üîß Basic VPN Solution - VPN simple y funcional');
    console.log('  üìä Quantum Constants - Constantes unificadas');
    console.log('');
    console.log('üÜï SISTEMAS NUEVOS:');
    console.log('  üß† Smart Proxy - Rotaci√≥n autom√°tica de proveedores');
    console.log('  üìä Proxy Monitor - Dashboard de monitoreo web');
    console.log('  üéõÔ∏è Unified Launcher - Selector inteligente');
    console.log('  ‚öôÔ∏è Proxy Config - Configuraci√≥n interactiva');
    console.log('');
    console.log('üéØ CARACTER√çSTICAS:');
    console.log('  ‚úÖ Detecci√≥n autom√°tica de IP');
    console.log('  ‚úÖ Selecci√≥n inteligente de m√©todo');
    console.log('  ‚úÖ Fallback autom√°tico');
    console.log('  ‚úÖ Monitoreo en tiempo real');
    console.log('  ‚úÖ Configuraci√≥n cu√°ntica avanzada');
    console.log('');
}

// Si se ejecuta directamente
if (require.main === module) {
    const args = process.argv.slice(2);
    const integratedSystem = new QBTCIntegratedVPNSystem();

    if (args.includes('--auto') || args.includes('-a')) {
        // Modo autom√°tico
        integratedSystem.runIntegratedSystem();
    } else if (args.includes('--interactive') || args.includes('-i')) {
        // Modo interactivo
        integratedSystem.runInteractive();
    } else if (args.includes('--status') || args.includes('-s')) {
        // Solo mostrar estado
        integratedSystem.initializeSystems().then(async () => {
            const status = await integratedSystem.getSystemStatus();
            console.log(JSON.stringify(status, null, 2));
        });
    } else {
        // Mostrar ayuda
        showSystemInfo();
        console.log('üéõÔ∏è QBTC INTEGRATED VPN SYSTEM');
        console.log('=============================');
        console.log('Uso:');
        console.log('  node qbtc-integrated-vpn-system.cjs --auto         # Autom√°tico');
        console.log('  node qbtc-integrated-vpn-system.cjs --interactive  # Interactivo');
        console.log('  node qbtc-integrated-vpn-system.cjs --status       # Estado');
        console.log('  node qbtc-integrated-vpn-system.cjs                # Esta ayuda');
        console.log('');
        console.log('Ejemplos:');
        console.log('  node qbtc-integrated-vpn-system.cjs --auto         # Sistema completo');
        console.log('  node qbtc-integrated-vpn-system.cjs --interactive  # Men√∫ completo');
        process.exit(0);
    }

    // Manejar se√±ales de terminaci√≥n
    process.on('SIGINT', () => {
        console.log('\nüîÑ Integrated VPN System detenido por SIGINT');
        process.exit(0);
    });

    process.on('SIGTERM', () => {
        console.log('\nüîÑ Integrated VPN System detenido por SIGTERM');
        process.exit(0);
    });
}

// Exportar la clase
module.exports = { QBTCIntegratedVPNSystem };