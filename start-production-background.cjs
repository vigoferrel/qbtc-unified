#!/usr/bin/env node

/*
  QBTC-UNIFIED PRODUCTION BACKGROUND STARTER
  Inicia el sistema completo en segundo plano con reportes de m√©tricas
*/

const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üåå QBTC-UNIFIED PRODUCTION BACKGROUND STARTER');
console.log('============================================');
console.log('üéØ Iniciando sistema completo en segundo plano...');
console.log('üìç Backend: Supabase (https://hrvxsaolaxnqltomqaud.supabase.co)');
console.log('');

class BackgroundSystemStarter {
    constructor() {
        this.processes = new Map();
        this.startTime = Date.now();
        
        this.config = {
            leonardoPort: 3003,
            masterPort: 3203,
            frontendPort: 8080,
            mode: 'production'
        };
    }
    
    async start() {
        try {
            console.log('üöÄ PASO 1: Iniciando Leonardo Consciousness en segundo plano');
            await this.startLeonardoBackground();
            
            console.log('‚è≥ PASO 2: Esperando estabilizaci√≥n (10 segundos)');
            await this.wait(10000);
            
            console.log('üåü PASO 3: Iniciando Sistema Unificado Maestro');  
            await this.startUnifiedMaster();
            
            console.log('‚úÖ PASO 4: Validaci√≥n del sistema');
            await this.validateSystem();
            
            this.showSystemInfo();
            this.setupMonitoring();
            this.setupGracefulShutdown();
            
            // Mantener el script vivo para supervisi√≥n
            this.keepAlive();
            
        } catch (error) {
            console.error('‚ùå Error en inicio:', error.message);
            process.exit(1);
        }
    }
    
    async startLeonardoBackground() {
        console.log('üß† Iniciando Leonardo Consciousness (BIG_BANG MODE)...');
        
        const leonardoProcess = spawn('node', ['leonardo-consciousness/start-leonardo.js'], {
            stdio: ['ignore', 'pipe', 'pipe'],
            detached: false,
            env: {
                ...process.env,
                AUTO_SELECT: '4', // BIG_BANG mode
                LEONARDO_PORT: this.config.leonardoPort.toString(),
                AUTO_START: 'true'
            }
        });
        
        this.processes.set('leonardo', leonardoProcess);
        
        // Configurar logging para Leonardo
        const leonardoLogStream = fs.createWriteStream('leonardo-background.log', { flags: 'a' });
        const leonardoErrorStream = fs.createWriteStream('leonardo-error.log', { flags: 'a' });
        
        leonardoProcess.stdout.on('data', (data) => {
            const output = data.toString();
            leonardoLogStream.write(`[${new Date().toISOString()}] ${output}`);
            // Solo mostrar l√≠neas importantes
            if (output.includes('‚úÖ') || output.includes('üéâ') || output.includes('‚ùå')) {
                console.log(`[LEONARDO] ${output.trim()}`);
            }
        });
        
        leonardoProcess.stderr.on('data', (data) => {
            const error = data.toString();
            leonardoErrorStream.write(`[${new Date().toISOString()}] ERROR: ${error}`);
            console.error(`[LEONARDO ERROR] ${error.trim()}`);
        });
        
        leonardoProcess.on('error', (error) => {
            console.error(`[LEONARDO SPAWN ERROR] ${error.message}`);
        });
        
        leonardoProcess.on('close', (code) => {
            console.log(`[LEONARDO] Proceso terminado con c√≥digo ${code}`);
            this.processes.delete('leonardo');
        });
        
        if (leonardoProcess.pid) {
            fs.writeFileSync('leonardo-background.pid', leonardoProcess.pid.toString());
            console.log(`‚úÖ Leonardo iniciado en segundo plano (PID: ${leonardoProcess.pid})`);
        }
    }
    
    async startUnifiedMaster() {
        console.log('üåü Iniciando Sistema Unificado Maestro...');
        
        const masterProcess = spawn('node', ['launch-quantum-unified-master.js'], {
            stdio: ['ignore', 'pipe', 'pipe'],
            detached: false,
            env: {
                ...process.env,
                HTTP_PORT: this.config.masterPort.toString(),
                DEPLOYMENT_MODE: this.config.mode
            }
        });
        
        this.processes.set('master', masterProcess);
        
        // Configurar logging para Master
        const masterLogStream = fs.createWriteStream('master-background.log', { flags: 'a' });
        const masterErrorStream = fs.createWriteStream('master-error.log', { flags: 'a' });
        
        masterProcess.stdout.on('data', (data) => {
            const output = data.toString();
            masterLogStream.write(`[${new Date().toISOString()}] ${output}`);
            // Solo mostrar l√≠neas importantes
            if (output.includes('‚úÖ') || output.includes('üéâ') || output.includes('‚ùå')) {
                console.log(`[MASTER] ${output.trim()}`);
            }
        });
        
        masterProcess.stderr.on('data', (data) => {
            const error = data.toString();
            masterErrorStream.write(`[${new Date().toISOString()}] ERROR: ${error}`);
            console.error(`[MASTER ERROR] ${error.trim()}`);
        });
        
        masterProcess.on('error', (error) => {
            console.error(`[MASTER SPAWN ERROR] ${error.message}`);
        });
        
        masterProcess.on('close', (code) => {
            console.log(`[MASTER] Proceso terminado con c√≥digo ${code}`);
            this.processes.delete('master');
        });
        
        if (masterProcess.pid) {
            fs.writeFileSync('master-background.pid', masterProcess.pid.toString());
            console.log(`‚úÖ Master iniciado en segundo plano (PID: ${masterProcess.pid})`);
        }
    }
    
    async validateSystem() {
        console.log('üîç Validando servicios...');
        
        // Esperar inicializaci√≥n
        await this.wait(5000);
        
        // Verificar Leonardo
        try {
            const http = require('http');
            await new Promise((resolve, reject) => {
                const req = http.get(`http://localhost:${this.config.leonardoPort}/health`, { timeout: 3000 }, (res) => {
                    if (res.statusCode === 200) {
                        console.log('‚úÖ Leonardo Consciousness: HEALTHY');
                        resolve();
                    } else {
                        console.log('‚ö†Ô∏è Leonardo Consciousness: A√∫n inicializando...');
                        resolve();
                    }
                });
                req.on('error', () => {
                    console.log('‚ö†Ô∏è Leonardo Consciousness: A√∫n inicializando...');
                    resolve();
                });
                req.on('timeout', () => {
                    req.abort();
                    resolve();
                });
            });
        } catch (error) {
            console.log('‚ö†Ô∏è Leonardo: Error en validaci√≥n');
        }
        
        // Verificar Master
        try {
            const http = require('http');
            await new Promise((resolve, reject) => {
                const req = http.get(`http://localhost:${this.config.masterPort}/api/health`, { timeout: 3000 }, (res) => {
                    if (res.statusCode === 200) {
                        console.log('‚úÖ Sistema Unificado: HEALTHY');
                        resolve();
                    } else {
                        console.log('‚ö†Ô∏è Sistema Unificado: A√∫n inicializando...');
                        resolve();
                    }
                });
                req.on('error', () => {
                    console.log('‚ö†Ô∏è Sistema Unificado: A√∫n inicializando...');
                    resolve();
                });
                req.on('timeout', () => {
                    req.abort();
                    resolve();
                });
            });
        } catch (error) {
            console.log('‚ö†Ô∏è Master: Error en validaci√≥n');
        }
    }
    
    showSystemInfo() {
        const uptime = Math.round((Date.now() - this.startTime) / 1000);
        
        console.log('');
        console.log('üéâ SISTEMA INICIADO EN SEGUNDO PLANO! üéâ');
        console.log('======================================');
        console.log('');
        console.log('üìä INFORMACI√ìN DEL SISTEMA:');
        console.log(`  ‚Ä¢ Tiempo de inicio: ${uptime} segundos`);
        console.log(`  ‚Ä¢ Procesos activos: ${this.processes.size}`);
        console.log(`  ‚Ä¢ Modo: ${this.config.mode}`);
        
        console.log('');
        console.log('üî¢ PIDs DE PROCESOS:');
        if (fs.existsSync('leonardo-background.pid')) {
            const leonardoPid = fs.readFileSync('leonardo-background.pid', 'utf8').trim();
            console.log(`  ‚Ä¢ Leonardo Consciousness: ${leonardoPid}`);
        }
        if (fs.existsSync('master-background.pid')) {
            const masterPid = fs.readFileSync('master-background.pid', 'utf8').trim();
            console.log(`  ‚Ä¢ Sistema Unificado Maestro: ${masterPid}`);
        }
        
        console.log('');
        console.log('üåê URLS DE ACCESO:');
        console.log(`  ‚Ä¢ Leonardo Dashboard: http://localhost:${this.config.leonardoPort}/dashboard`);
        console.log(`  ‚Ä¢ Leonardo Health: http://localhost:${this.config.leonardoPort}/health`);
        console.log(`  ‚Ä¢ Master Dashboard: http://localhost:${this.config.masterPort}`);
        console.log(`  ‚Ä¢ Master Health: http://localhost:${this.config.masterPort}/api/health`);
        console.log('  ‚Ä¢ Supabase Backend: https://hrvxsaolaxnqltomqaud.supabase.co');
        
        console.log('');
        console.log('üìÇ LOGS DE BACKGROUND:');
        console.log('  ‚Ä¢ Leonardo Output: leonardo-background.log');
        console.log('  ‚Ä¢ Leonardo Errors: leonardo-error.log');
        console.log('  ‚Ä¢ Master Output: master-background.log');
        console.log('  ‚Ä¢ Master Errors: master-error.log');
        
        console.log('');
        console.log('üîß COMANDOS DE MONITOREO:');
        console.log('  ‚Ä¢ Estado del sistema: node check-system-status.js');
        console.log('  ‚Ä¢ Ver logs Leonardo: Get-Content leonardo-background.log -Tail 20 -Wait');
        console.log('  ‚Ä¢ Ver logs Master: Get-Content master-background.log -Tail 20 -Wait');
        console.log('  ‚Ä¢ Test Supabase: node supabase-integration.js');
        
        console.log('');
        console.log('‚ú® SISTEMA CORRIENDO EN BACKGROUND CON M√ÅXIMA EXTRACCI√ìN DE JUGO CU√ÅNTICO! ‚ú®');
        console.log('');
    }
    
    setupMonitoring() {
        // Monitoreo peri√≥dico cada 60 segundos
        setInterval(async () => {
            console.log('üìä Monitoreo peri√≥dico del sistema...');
            
            // Verificar procesos vivos
            let processesAlive = 0;
            for (const [name, process] of this.processes) {
                if (!process.killed) {
                    processesAlive++;
                } else {
                    console.log(`‚ö†Ô∏è Proceso ${name} no est√° activo`);
                }
            }
            
            console.log(`üìà Procesos activos: ${processesAlive}/${this.processes.size}`);
            
            // Log del estado cada hora
            const uptime = Math.round((Date.now() - this.startTime) / 1000);
            if (uptime % 3600 === 0) { // Cada hora
                console.log(`‚è∞ Sistema corriendo por ${Math.round(uptime/3600)} horas`);
            }
            
        }, 60000); // 60 segundos
    }
    
    setupGracefulShutdown() {
        const handleShutdown = async () => {
            console.log('');
            console.log('üîÑ INICIANDO SHUTDOWN GRACEFUL DEL SISTEMA COMPLETO...');
            
            for (const [name, process] of this.processes) {
                try {
                    console.log(`üîí Cerrando proceso ${name}...`);
                    process.kill('SIGTERM');
                } catch (error) {
                    console.error(`‚ùå Error cerrando ${name}:`, error.message);
                }
            }
            
            // Esperar que los procesos se cierren
            await this.wait(3000);
            
            console.log('üîí SISTEMA COMPLETAMENTE CERRADO');
            process.exit(0);
        };
        
        process.on('SIGINT', handleShutdown);
        process.on('SIGTERM', handleShutdown);
    }
    
    keepAlive() {
        // Mantener el proceso supervisor vivo
        console.log('üîÑ Supervisor activo - manteniendo sistema vivo...');
        console.log('üí° Usa Ctrl+C para cerrar todo el sistema');
        console.log('');
        
        // Loop infinito ligero
        setInterval(() => {
            // Heartbeat ligero cada 5 minutos
        }, 300000);
    }
    
    async wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Ejecutar
const starter = new BackgroundSystemStarter();
starter.start().catch(error => {
    console.error('üí• Error fatal:', error.message);
    process.exit(1);
});
